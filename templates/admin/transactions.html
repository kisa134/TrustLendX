{% extends 'admin/base_admin.html' %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock admin_content %}

{% block admin_content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Управление транзакциями</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Вернуться к панели
                </a>
            </div>
        </div>
    </div>

    <!-- Статистика по статусам -->
    <div class="row mb-4">
        {% set completed = transactions|selectattr('status', 'equalto', 'completed')|list|length %}
        {% set awaiting = transactions|selectattr('status', 'equalto', 'payment_awaiting')|list|length %}
        {% set pending = transactions|selectattr('status', 'equalto', 'pending')|list|length %}
        {% set failed = transactions|selectattr('status', 'equalto', 'failed')|list|length %}
        {% set cancelled = transactions|selectattr('status', 'equalto', 'cancelled')|list|length %}
        
        <div class="col">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5>Всего</h5>
                    <h3>{{ transactions|length }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5>Завершенные</h5>
                    <h3 class="text-success">{{ completed }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5>Ожидающие оплаты</h5>
                    <h3 class="text-warning">{{ awaiting }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5>В обработке</h5>
                    <h3 class="text-info">{{ pending }}</h3>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card bg-dark border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5>Отмененные/Неудачные</h5>
                    <h3 class="text-danger">{{ failed + cancelled }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Список транзакций -->
    <div class="card bg-dark border-0 shadow-sm mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Все транзакции</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-sm admin-table" id="transactionsTable">
                    <thead>
                        <tr>
                            <th>ID транзакции</th>
                            <th>Пользователь</th>
                            <th>Сумма</th>
                            <th>Статус</th>
                            <th>Дата создания</th>
                            <th>Источник</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.transaction_id }}</td>
                            <td>
                                {% set user = User.query.get(transaction.user_id) %}
                                {% if user %}
                                <a href="{{ url_for('admin_user_details', user_id=user.id) }}">
                                    {{ user.username }}
                                </a>
                                {% else %}
                                Пользователь удален
                                {% endif %}
                            </td>
                            <td>{{ "%.2f"|format(transaction.amount) }} USDT</td>
                            <td>
                                {% if transaction.status == 'completed' %}
                                <span class="badge bg-success">Завершена</span>
                                {% elif transaction.status == 'pending' %}
                                <span class="badge bg-secondary">Ожидает</span>
                                {% elif transaction.status == 'payment_awaiting' %}
                                <span class="badge bg-warning">Ожидает оплаты</span>
                                {% elif transaction.status == 'failed' %}
                                <span class="badge bg-danger">Ошибка</span>
                                {% elif transaction.status == 'cancelled' %}
                                <span class="badge bg-danger">Отменена</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ transaction.status }}</span>
                                {% endif %}
                            </td>
                            <td>{{ transaction.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                            <td>
                                {% if transaction.source == 'ton' %}
                                <span class="badge bg-info">TON</span>
                                {% else %}
                                <span class="badge bg-primary">NOWPayments</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if transaction.type == 'regular' %}
                                <a href="{{ url_for('admin_transaction_details', transaction_id=transaction.transaction_id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% else %}
                                <!-- Для TON-транзакций отображаем переключатель статуса -->
                                <div class="d-flex align-items-center">
                                    <span class="me-2 badge bg-info">TON</span>
                                    <div class="form-check form-switch mb-0">
                                        <input class="form-check-input ton-status-toggle" 
                                               type="checkbox" 
                                               id="ton_status_{{ transaction.id }}" 
                                               data-id="{{ transaction.id }}"
                                               data-memo="{{ transaction.transaction_id }}"
                                               {% if transaction.status == 'completed' %}checked{% endif %}
                                               onchange="toggleTonStatus(this)">
                                        <label class="form-check-label small" for="ton_status_{{ transaction.id }}">
                                            {% if transaction.status == 'completed' %}Завершена{% else %}Ожидает{% endif %}
                                        </label>
                                        <small class="d-block text-muted mt-1">
                                            (№{{ transaction.id }}) {{ transaction.transaction_id }}
                                        </small>
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock admin_content %}

<!-- Модальное окно для изменения статуса TON-транзакции -->
<div class="modal fade" id="tonStatusModal" tabindex="-1" aria-labelledby="tonStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="tonStatusModalLabel">Управление TON-транзакцией</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="tonStatusForm" action="" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="type" value="ton">
                    <input type="hidden" name="transaction_id" id="transaction_id_hidden" value="">
                    <div class="mb-3">
                        <label for="transaction_id" class="form-label">ID транзакции</label>
                        <input type="text" class="form-control" id="transaction_id" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="status" class="form-label">Статус</label>
                        <select class="form-select" id="status" name="status">
                            <option value="pending">В обработке</option>
                            <option value="payment_awaiting">Ожидает оплаты</option>
                            <option value="completed">Завершена</option>
                            <option value="failed">Ошибка</option>
                            <option value="cancelled">Отменена</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle"></i> Изменение статуса на "Завершена" автоматически установит дату подтверждения платежа.
                        </small>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Функция для открытия модального окна TON и настройки его содержимого
function openTonStatusModal(button) {
    console.log("Открытие модального окна через функцию openTonStatusModal");
    
    var transactionId = button.getAttribute('data-id');
    var status = button.getAttribute('data-status');
    
    console.log("ID транзакции:", transactionId);
    console.log("Статус:", status);
    
    var form = document.getElementById('tonStatusForm');
    var idInput = document.getElementById('transaction_id');
    var idInputHidden = document.getElementById('transaction_id_hidden');
    var statusSelect = document.getElementById('status');
    
    idInput.value = transactionId;
    idInputHidden.value = transactionId;
    statusSelect.value = status;
    
    form.action = "/admin/transaction/" + transactionId + "/update-status";
    
    console.log("Модальное окно настроено:", {
        action: form.action,
        idValue: idInput.value,
        hiddenIdValue: idInputHidden.value,
        statusValue: statusSelect.value
    });
    
    // Открываем модальное окно программно
    var modal = new bootstrap.Modal(document.getElementById('tonStatusModal'));
    modal.show();
}

// Функция для изменения статуса TON-транзакции с помощью переключателя
function toggleTonStatus(toggleElement) {
    console.log("Переключатель статуса TON сработал");
    
    // Получаем ID транзакции (числовой ID из базы данных)
    var transactionId = toggleElement.getAttribute('data-id');
    var memoId = toggleElement.getAttribute('data-memo');
    
    // Определяем новый статус на основе состояния переключателя
    var newStatus = toggleElement.checked ? 'completed' : 'payment_awaiting';
    
    // Получаем метку переключателя
    var label = toggleElement.nextElementSibling;
    
    console.log("Изменение статуса TON-транзакции:", {
        id: transactionId,
        memo: memoId,
        newStatus: newStatus,
        checked: toggleElement.checked
    });
    
    // Показываем индикатор загрузки
    toggleElement.disabled = true;
    label.textContent = "Обновляем...";
    
    // Создаем простую форму для отправки
    var formData = new FormData();
    formData.append('type', 'ton');
    formData.append('status', newStatus);
    formData.append('db_id', transactionId);  // Явно передаем ID записи в базе
    
    // Отправляем запрос на обновление статуса по числовому ID
    fetch('/admin/ton-transaction/' + transactionId + '/update-status', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("Получен ответ:", response.status, response.statusText);
        if (!response.ok) {
            throw new Error('Ошибка при обновлении статуса: ' + response.status);
        }
        return response.json().catch(error => {
            console.error("Ошибка парсинга JSON:", error);
            return {}; // Если ответ не JSON, возвращаем пустой объект
        });
    })
    .then(data => {
        console.log("Статус успешно обновлен:", data);
        
        // Обновляем текст метки
        label.textContent = toggleElement.checked ? "Завершена" : "Ожидает";
        
        // Если нужно, можно обновить другие элементы страницы
        // Например, обновить общую статистику или цвет строки в таблице
        
        // Анимация успешного завершения
        label.style.color = "#28a745";
        setTimeout(() => {
            label.style.color = "";
        }, 2000);
    })
    .catch(error => {
        console.error("Ошибка при обновлении статуса:", error);
        
        // Возвращаем переключатель в исходное состояние
        toggleElement.checked = !toggleElement.checked;
        label.textContent = toggleElement.checked ? "Завершена" : "Ожидает";
        
        // Анимация ошибки
        label.style.color = "#dc3545";
        setTimeout(() => {
            label.style.color = "";
        }, 2000);
        
        // Показываем сообщение об ошибке
        alert("Произошла ошибка при обновлении статуса транзакции. Пожалуйста, попробуйте еще раз.");
    })
    .finally(() => {
        // В любом случае, включаем переключатель обратно
        toggleElement.disabled = false;
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Проверяем наличие CSRF-токена в форме и мета-тегах
    var csrfTokenInput = document.querySelector('input[name="csrf_token"]');
    var metaTokenTag = document.querySelector('meta[name="csrf-token"]');
    
    console.log("Проверка CSRF токенов:", {
        "В форме": csrfTokenInput ? "Найден" : "Не найден",
        "В meta": metaTokenTag ? "Найден" : "Не найден"
    });
    
    // Добавляем CSRF-токен в meta-тег, если его нет, но есть в форме
    if (!metaTokenTag && csrfTokenInput) {
        const csrfToken = csrfTokenInput.value;
        const metaToken = document.createElement('meta');
        metaToken.name = 'csrf-token';
        metaToken.content = csrfToken;
        document.head.appendChild(metaToken);
        console.log("CSRF токен добавлен в meta");
    }
    
    // Находим все переключатели TON-статуса
    console.log("Инициализация переключателей TON-статуса");
    const tonToggles = document.querySelectorAll('.ton-status-toggle');
    console.log("Найдено TON-переключателей:", tonToggles.length);
    
    // Логируем ID транзакций для проверки
    tonToggles.forEach(toggle => {
        const id = toggle.getAttribute('data-id');
        const isChecked = toggle.checked;
        console.log(`Переключатель TON: id=${id}, статус=${isChecked ? 'Завершена' : 'Ожидает'}`);
    });
    
    // Инициализируем модальное окно (оставляем для совместимости)
    var tonStatusModal = document.getElementById('tonStatusModal');
    if (tonStatusModal) {
        console.log("Модальное окно TON найдено");
    }
});
</script>
{% endblock admin_content %}