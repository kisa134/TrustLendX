{% extends "admin/base_admin.html" %}

{% block admin_content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-2 text-gray-800">
                <i class="fas fa-credit-card me-2"></i> Запросы на вывод средств
            </h1>
            <p class="mb-4">Управление запросами на вывод средств от инвесторов</p>
        </div>
    </div>
    
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Всего запросов
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ requests|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Ожидают обработки
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ requests|selectattr('status', 'equalto', 'pending')|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Одобрено и выполнено
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ requests|selectattr('status', 'in', ['approved', 'completed'])|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col me-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Отклонено
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ requests|selectattr('status', 'equalto', 'rejected')|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold">Список запросов на вывод</h6>
            <div>
                <a href="#" class="btn btn-sm btn-outline-primary filter-button" data-filter="all">
                    <i class="fas fa-list me-1"></i> Все
                </a>
                <a href="#" class="btn btn-sm btn-outline-warning filter-button" data-filter="pending">
                    <i class="fas fa-clock me-1"></i> Ожидают
                </a>
                <a href="#" class="btn btn-sm btn-outline-success filter-button" data-filter="approved">
                    <i class="fas fa-check me-1"></i> Одобрены
                </a>
                <a href="#" class="btn btn-sm btn-outline-secondary filter-button" data-filter="completed">
                    <i class="fas fa-check-double me-1"></i> Выполнены
                </a>
                <a href="#" class="btn btn-sm btn-outline-danger filter-button" data-filter="rejected">
                    <i class="fas fa-times me-1"></i> Отклонены
                </a>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="withdrawalRequestsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Пользователь</th>
                            <th>Сумма</th>
                            <th>Сеть</th>
                            <th>Дата запроса</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if requests %}
                            {% for request in requests %}
                                <tr class="withdrawal-row" data-status="{{ request.status }}">
                                    <td>{{ request.id }}</td>
                                    <td>
                                        <a href="{{ url_for('admin_user_details', user_id=request.user_id) }}" class="text-decoration-none">
                                            {{ request.user.username }}
                                        </a>
                                    </td>
                                    <td>{{ request.amount }} USDT</td>
                                    <td>{{ request.network }}</td>
                                    <td>{{ request.request_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        {% if request.status == 'pending' %}
                                            <span class="badge bg-warning py-2 px-3">Ожидает</span>
                                        {% elif request.status == 'approved' %}
                                            <span class="badge bg-info py-2 px-3">Одобрен</span>
                                        {% elif request.status == 'completed' %}
                                            <span class="badge bg-success py-2 px-3">Выполнен</span>
                                        {% elif request.status == 'rejected' %}
                                            <span class="badge bg-danger py-2 px-3">Отклонен</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-primary view-details" data-id="{{ request.id }}" data-bs-toggle="modal" data-bs-target="#withdrawalDetailModal">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if request.status == 'pending' %}
                                            <a href="{{ url_for('withdrawal_routes.admin_approve_withdrawal', request_id=request.id) }}" class="btn btn-sm btn-success">
                                                <i class="fas fa-check"></i>
                                            </a>
                                            <a href="{{ url_for('withdrawal_routes.admin_reject_withdrawal', request_id=request.id) }}" class="btn btn-sm btn-danger">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        {% elif request.status == 'approved' %}
                                            <a href="{{ url_for('withdrawal_routes.admin_complete_withdrawal', request_id=request.id) }}" class="btn btn-sm btn-success">
                                                <i class="fas fa-check-double"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <p class="text-muted mb-0">Запросы на вывод средств отсутствуют</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра деталей запроса -->
<div class="modal fade" id="withdrawalDetailModal" tabindex="-1" aria-labelledby="withdrawalDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawalDetailModalLabel">Детали запроса на вывод</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="withdrawalDetails">
                    <!-- Данные будут загружены через AJAX -->
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Загрузка информации...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <div id="withdrawalActionButtons">
                    <!-- Кнопки действий будут добавлены через JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock admin_content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Фильтрация запросов
        const filterButtons = document.querySelectorAll('.filter-button');
        const rows = document.querySelectorAll('.withdrawal-row');
        
        filterButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                const filter = this.dataset.filter;
                
                // Активируем текущую кнопку
                filterButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Фильтруем строки
                rows.forEach(row => {
                    if (filter === 'all') {
                        row.style.display = '';
                    } else {
                        row.style.display = row.dataset.status === filter ? '' : 'none';
                    }
                });
            });
        });
        
        // Просмотр деталей запроса
        const viewButtons = document.querySelectorAll('.view-details');
        
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const requestId = this.dataset.id;
                loadRequestDetails(requestId);
            });
        });
        
        function loadRequestDetails(requestId) {
            // Здесь будет загрузка деталей запроса через AJAX
            // Для примера, заполняем статической информацией
            
            document.getElementById('withdrawalDetails').innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> 
                    Информация о запросе на вывод будет загружена через API.
                </div>
                <p>Запрос ID: ${requestId}</p>
            `;
            
            // Обновляем кнопки действий
            const rowStatus = document.querySelector(`.withdrawal-row[data-id="${requestId}"]`)?.dataset.status;
            
            let buttonsHtml = '';
            
            if (rowStatus === 'pending') {
                buttonsHtml = `
                    <a href="/admin/withdrawal-requests/${requestId}/approve" class="btn btn-success">
                        <i class="fas fa-check me-1"></i> Одобрить
                    </a>
                    <a href="/admin/withdrawal-requests/${requestId}/reject" class="btn btn-danger">
                        <i class="fas fa-times me-1"></i> Отклонить
                    </a>
                `;
            } else if (rowStatus === 'approved') {
                buttonsHtml = `
                    <a href="/admin/withdrawal-requests/${requestId}/complete" class="btn btn-success">
                        <i class="fas fa-check-double me-1"></i> Отметить выполненным
                    </a>
                `;
            }
            
            document.getElementById('withdrawalActionButtons').innerHTML = buttonsHtml;
        }
    });
</script>
{% endblock admin_content %}