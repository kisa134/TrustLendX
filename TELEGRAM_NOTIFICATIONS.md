# Система уведомлений Telegram в TrustLendX

Этот документ описывает систему уведомлений через Telegram, разработанную для платформы TrustLendX.

## Обзор системы

Система уведомлений Telegram предназначена для мгновенного информирования администраторов о важных событиях в платформе, таких как:

- Создание новых TON депозитов
- Изменение статуса транзакций
- Нажатие пользователем кнопки "Я оплатил"

## Структура компонентов

Система состоит из следующих компонентов:

1. **telegram_notification.py** - Основной модуль для отправки уведомлений через Telegram API
2. **ton_deposit_routes.py** - Маршруты для обработки TON депозитов, интегрированные с системой уведомлений
3. **test_telegram_notification.py** - Скрипт для тестирования системы уведомлений

## Типы уведомлений

### 1. Тестовое уведомление
```python
notify_test_notification()
```
Простое тестовое уведомление для проверки работоспособности системы.

### 2. Уведомление о новом TON депозите
```python
notify_new_ton_deposit(user_id, amount, memo, transaction_id)
```
Отправляется при нажатии пользователем кнопки "Я оплатил" для информирования администраторов о необходимости проверки платежа.

### 3. Уведомление об изменении статуса TON депозита
```python
notify_ton_deposit_status_change(user_id, amount, memo, transaction_id, new_status)
```
Отправляется при изменении статуса TON депозита (например, с "pending" на "completed").

## Режимы работы

Система может работать в двух режимах:

1. **Режим имитации (USE_MOCK_MODE = True)** - Сохраняет уведомления в файл `telegram_notifications.json` вместо реальной отправки. Полезно для тестирования и отладки.

2. **Реальный режим (USE_MOCK_MODE = False)** - Отправляет реальные уведомления в указанный чат Telegram.

## Настройка

### Переменные окружения

Для работы системы необходимо настроить следующие переменные окружения (в файле `.env`):

```
TELEGRAM_TOKEN=ваш_токен_бота
TELEGRAM_CHAT_ID=идентификатор_чата
```

### Создание Telegram бота

1. Откройте Telegram и найдите бота @BotFather
2. Отправьте ему команду `/newbot`
3. Следуйте инструкциям для создания нового бота
4. Получите токен бота и сохраните его в переменной `TELEGRAM_TOKEN`

### Получение Chat ID

1. Добавьте своего бота в чат, где нужно получать уведомления
2. Отправьте сообщение в этот чат
3. Посетите `https://api.telegram.org/bot<ваш_токен>/getUpdates`
4. Найдите поле `chat.id` в ответе JSON
5. Сохраните ID чата в переменной `TELEGRAM_CHAT_ID`

## Тестирование системы

Для тестирования системы уведомлений используйте скрипт `test_telegram_notification.py`:

```bash
python test_telegram_notification.py
```

## Настройка режима работы

Для переключения между режимом имитации и реальной отправкой уведомлений, измените значение переменной `USE_MOCK_MODE` в файле `telegram_notification.py`:

```python
# Режим имитации (без реальной отправки)
USE_MOCK_MODE = True

# Режим реальной отправки уведомлений
USE_MOCK_MODE = False
```

## Просмотр сохраненных уведомлений

В режиме имитации уведомления сохраняются в файл `telegram_notifications.json`. Для просмотра содержимого файла можно использовать следующую команду:

```bash
python test_telegram_notification.py --show-mock
```

## Отладка

В случае проблем с отправкой уведомлений, проверьте:

1. Наличие и правильность переменных окружения
2. Доступность Telegram API
3. Права бота в чате (бот должен иметь права на отправку сообщений)
4. Лог ошибок в консоли приложения